{"version":3,"file":"user_search.min.js","sources":["../src/user_search.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * User search functionality for lifestory report.\n *\n * @module     report_lifestory/user_search\n * @copyright  2025 Datacurso\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/notification'], function ($, Ajax, Notification) {\n\n    let searchTimeout = null;\n    const SEARCH_DELAY = 300;\n\n    /**\n     * Search for students\n     * @param {string} query Search query\n     * @return {Promise}\n     */\n    const searchStudents = function (query) {\n        return Ajax.call([{\n            methodname: 'report_lifestory_search_students',\n            args: { query: query }\n        }])[0];\n    };\n\n    /**\n     * Render search results\n     * @param {Array} results Array of student objects\n     * @param {string} baseUrl Base URL for links\n     */\n    const renderResults = function (results, baseUrl) {\n        const container = $('#search-results');\n        container.empty();\n\n        if (!results || results.length === 0) {\n            container.addClass('d-none');\n            return;\n        }\n\n        let html = '';\n        results.forEach(function (student) {\n            const avatar = student.profileimageurl\n                ? `<img src=\"${student.profileimageurl}\" alt=\"${student.fullname}\"\n                         class=\"rounded-circle me-3\" style=\"width:40px; height:40px; object-fit:cover;\">`\n                : `<div class=\"rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3\"\n                         style=\"width:40px; height:40px; flex-shrink:0; font-size:18px; font-weight:bold;\">\n                         ${student.fullname.charAt(0).toUpperCase()}\n                   </div>`;\n\n            html += `\n                <a href=\"${baseUrl}?userid=${student.id}\"\n                   class=\"d-block p-2 text-decoration-none border-bottom\"\n                   style=\"color: inherit; transition: background-color 0.15s;\">\n                    <div class=\"d-flex align-items-center\">\n                        ${avatar}\n                        <div>\n                            <div class=\"fw-bold\">${student.fullname}</div>\n                            <small class=\"text-muted\">${student.email}</small>\n                        </div>\n                    </div>\n                </a>\n            `;\n        });\n\n        container.html(html).removeClass('d-none');\n\n        // Hover effect similar to Moodle\n        container.find('a').hover(\n            function () { $(this).css('background-color', '#f8f9fa'); },\n            function () { $(this).css('background-color', ''); }\n        );\n    };\n\n    /**\n     * Initialize the user search\n     * @param {string} baseUrl Base URL for the page\n     */\n    const init = function (baseUrl) {\n        const searchInput = $('#usersearch');\n        const clearButton = $('#clearsearch');\n        const resultsContainer = $('#search-results');\n\n        if (searchInput.length === 0) {\n            return;\n        }\n\n        // --- Input event ---\n        searchInput.on('input', function () {\n            const query = $(this).val().trim();\n\n            // Mostrar / ocultar la X\n            if (query.length > 0) {\n                clearButton.show();\n            } else {\n                clearButton.hide();\n                resultsContainer.addClass('d-none').empty();\n                return;\n            }\n\n            // Cancelar búsqueda anterior\n            if (searchTimeout) {\n                clearTimeout(searchTimeout);\n            }\n\n            // Esperar un poco antes de buscar\n            searchTimeout = setTimeout(function () {\n                searchStudents(query)\n                    .then(function (response) {\n                        const students = response && response.students ? response.students : [];\n                        renderResults(students, baseUrl);\n                    })\n                    .catch(Notification.exception);\n            }, SEARCH_DELAY);\n        });\n\n        // --- Botón limpiar dentro del input ---\n        clearButton.on('click', function (e) {\n            e.preventDefault();\n            searchInput.val('');\n            clearButton.hide();\n            resultsContainer.addClass('d-none').empty();\n            searchInput.focus();\n        });\n\n        // --- Mostrar resultados al enfocar ---\n        searchInput.on('focus', function () {\n            const query = $(this).val().trim();\n            if (query.length > 0 && resultsContainer.children().length > 0) {\n                resultsContainer.removeClass('d-none');\n            }\n        });\n\n        // --- Ocultar resultados al hacer clic fuera ---\n        $(document).on('click', function (e) {\n            if (!$(e.target).closest('#usersearch-wrapper').length) {\n                resultsContainer.addClass('d-none');\n            }\n        });\n\n        // --- Evitar submit con Enter ---\n        searchInput.on('keydown', function (e) {\n            if (e.key === 'Enter') {\n                e.preventDefault();\n            }\n        });\n    };\n\n    return { init: init };\n});\n"],"names":["define","$","Ajax","Notification","searchTimeout","init","baseUrl","searchInput","clearButton","resultsContainer","length","on","query","this","val","trim","hide","addClass","empty","show","clearTimeout","setTimeout","call","methodname","args","searchStudents","then","response","results","container","html","forEach","student","avatar","profileimageurl","fullname","charAt","toUpperCase","id","email","removeClass","find","hover","css","renderResults","students","catch","exception","e","preventDefault","focus","children","document","target","closest","key"],"mappings":";;;;;;;AAuBAA,sCAAO,CAAC,SAAU,YAAa,sBAAsB,SAAUC,EAAGC,KAAMC,kBAEhEC,cAAgB,WAyIb,CAAEC,KAtEI,SAAUC,eACbC,YAAcN,EAAE,eAChBO,YAAcP,EAAE,gBAChBQ,iBAAmBR,EAAE,mBAEA,IAAvBM,YAAYG,SAKhBH,YAAYI,GAAG,SAAS,iBACdC,MAAQX,EAAEY,MAAMC,MAAMC,YAGxBH,MAAMF,OAAS,UAGfF,YAAYQ,YACZP,iBAAiBQ,SAAS,UAAUC,QAHpCV,YAAYW,OAQZf,eACAgB,aAAahB,eAIjBA,cAAgBiB,YAAW,YAvFZ,SAAUT,cACtBV,KAAKoB,KAAK,CAAC,CACdC,WAAY,mCACZC,KAAM,CAAEZ,MAAOA,UACf,IAoFIa,CAAeb,OACVc,MAAK,SAAUC,WA7EV,SAAUC,QAAStB,eAC/BuB,UAAY5B,EAAE,sBACpB4B,UAAUX,SAELU,SAA8B,IAAnBA,QAAQlB,mBACpBmB,UAAUZ,SAAS,cAInBa,KAAO,GACXF,QAAQG,SAAQ,SAAUC,eAChBC,OAASD,QAAQE,oCACJF,QAAQE,kCAAyBF,QAAQG,iXAI7CH,QAAQG,SAASC,OAAO,GAAGC,6CAG1CP,2CACexB,2BAAkB0B,QAAQM,kQAI3BL,oGAEyBD,QAAQG,kFACHH,QAAQO,qHAOxDV,UAAUC,KAAKA,MAAMU,YAAY,UAGjCX,UAAUY,KAAK,KAAKC,OAChB,WAAczC,EAAEY,MAAM8B,IAAI,mBAAoB,cAC9C,WAAc1C,EAAEY,MAAM8B,IAAI,mBAAoB,OAwClCC,CADiBjB,UAAYA,SAASkB,SAAWlB,SAASkB,SAAW,GAC7CvC,YAE3BwC,MAAM3C,aAAa4C,aApGf,QAyGjBvC,YAAYG,GAAG,SAAS,SAAUqC,GAC9BA,EAAEC,iBACF1C,YAAYO,IAAI,IAChBN,YAAYQ,OACZP,iBAAiBQ,SAAS,UAAUC,QACpCX,YAAY2C,WAIhB3C,YAAYI,GAAG,SAAS,WACNV,EAAEY,MAAMC,MAAMC,OAClBL,OAAS,GAAKD,iBAAiB0C,WAAWzC,OAAS,GACzDD,iBAAiB+B,YAAY,aAKrCvC,EAAEmD,UAAUzC,GAAG,SAAS,SAAUqC,GACzB/C,EAAE+C,EAAEK,QAAQC,QAAQ,uBAAuB5C,QAC5CD,iBAAiBQ,SAAS,aAKlCV,YAAYI,GAAG,WAAW,SAAUqC,GAClB,UAAVA,EAAEO,KACFP,EAAEC"}